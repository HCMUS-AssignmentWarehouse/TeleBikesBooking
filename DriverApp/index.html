<!DOCTYPE html>
<html>
<head>
	<title>Telephone Bikes Booking</title>
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>

<div>
  <ul id="ul-list">
    
  </ul>
</div>

 <div id="map"></div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAM0uiCd8v3-ef9qhPzZuOgWTPZON_SZvM&callback=initMap" async defer></script>
    <script src="js/map.js"></script>

<script src="js/jquery.min.js"></script>
<script src="assests/jquery-3.1.1.min.js"></script>
 

<script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
    <script>
              // Initialize Firebase
        var config = {
            apiKey: "AIzaSyCPsM92WXpL9n_APrHNbO0CtkT_FbAcuBY",
            authDomain: "barg-midterm.firebaseapp.com",
            databaseURL: "https://barg-midterm.firebaseio.com",
            projectId: "barg-midterm",
            storageBucket: "barg-midterm.appspot.com",
            messagingSenderId: "263139149669"
        };
        firebase.initializeApp(config);
    </script>
    <script type="text/javascript">
       // function test() {

            var database = firebase.database().ref('book-list');

            var setChildAddedMessage = function (data) {
               addNewLi(data);
                		          
               
            }.bind(this);


            var setChildChangedMessage = function (data) {
               
                var nums = document.getElementById("ul-list");
				var listItem = nums.getElementsByTagName("li");

				var newNums = [];

				for (var i=0; i < listItem.length; i++) {
				    if ($(listItem[i]).find(".key").text() == data.key){
				    	listItem[i].parentNode.removeChild(listItem[i]);
				    }
				}
				addNewLi(data);
						            
            }.bind(this);


            var setChildRemovedMessage = function (data) {
               
                var nums = document.getElementById("ul-list");
				var listItem = nums.getElementsByTagName("li");

				var newNums = [];

				for (var i=0; i < listItem.length; i++) {
				    if ($(listItem[i]).find(".key").text() == data.key){
				    	listItem[i].parentNode.removeChild(listItem[i]);
				    }
				}
						            
            }.bind(this);


            database.on('child_added', setChildAddedMessage);
            database.on('child_changed', setChildChangedMessage);
            database.on('child_removed', setChildRemovedMessage);
    </script>

<script type="text/javascript">
	function addNewLi(data){
		var c = data.val();
		if (c.state == "finding"){
			var li = '<li onclick="getDetail(this);"><img src="images/new-icon.png"/><p style="display: none" class="key">'+data.key+'</p><h3 >Address: <p class="address"  style="display:inline">'+c.address+'</p></h3>';

                	if (c.lat != null){
                		li += '<p style="display:inline">Lat: <p style="display:inline">'+c.lat+'</p></p>'+'<p>Long: '+c.long+'</p></p>';	
                	} 

                	li += '<p style="display:inline">Vehicle type: <p style="display:inline">'+c.vehicle+'</p></p>'
					+  '<p style="display:inline">State: <p style="display:inline"><strong>'+c.state+'</strong></p></p>'
					+  '<p style="display:inline">PhoneNumber: <p style="display:inline">'+c.phoneNumber+'<p></p>'
					+  '<p style="display:inline">Note: <p style="display:inline">'+c.note+'<p></p></li>';	
				
		            $('#ul-list').append(li);
		}
                
	}
</script>

<script type="text/javascript">
	// $(function() {
	// 	$.ajax({
	// 			url: `http://localhost:3003/booking-deals`,
	// 			dataType: 'json',
	// 			timeout: 10000
	// 		}).done(function(data){
			
	// 			$.each(data, function(idx, c) {
	// 				var li = '<li onclick="getDetail(this);"><img src="images/point-icon.png"/><h3>Address: '+c.address+'</h3>'+ '<p>Lat: '+c.lat+'</p>'+'<p>Long: '+c.long+'</p>'+ '<p>Vehicle type: '+c.vehicle+'</p>'
	// 				+  '<p>State: <strong>'+c.state+'</strong></p>'
	// 				+  '<p>PhoneNumber: '+c.phoneNumber+'</p>'
	// 				+  '<p>Note: '+c.note+'</p>';	
	// 				if (c.driverAddress != null){
	// 					li += '<h3>Driver information</h3><p>Driver address: '
	// 					+c.driverAddress+'</p><p>Driver name: '
	// 					+c.driverName+'</p><p>Driver phone number: '
	// 					+c.driverPhone+'</p></li>';
	// 				}

	// 	            $('#ul-list').append(li);
	//           	});
	          				
	// 		}).fail(function(jqXHR, textStatus, error){
	// 			console.log(textStatus);
	// 			console.log(error);
	// 			console.log(jqXHR);
	// 		});
	// });
</script>

<script type="text/javascript">

var map;
var marker;
var markers = [];

	function getDetail(item){
		$('li').removeClass('highlight_stay');
		 $(item).addClass('highlight_stay');

		//alert($(item).find(".address").text());
		//alert($(item).find(".driverAddress").text());
		var customerAddress = $(item).find(".address").text();
		var driverAddress = $(item).find(".driverAddress").text();

		var count = item.childElementCount;
		if (count < 12){
			alert("This point haven't been process yet or not enough information to continue!");
		}else{

			var geocoder = new google.maps.Geocoder();
		    var reverse = new google.maps.Geocoder();
		    var infowindow = new google.maps.InfoWindow;
		    marker = new google.maps.Marker(
		    {
		        position: { lat: -34.397, lng: 150.644 }
		    });

		    clearMarkers();
		    markers.push(marker);
			geocodeAddress(geocoder, map, infowindow, customerAddress);
		}
		
	}


 // Sets the map on all markers in the array.
 function setMapOnAll(map) {
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
    }
  }

  // Removes the markers from the map, but keeps them in the array.
  function clearMarkers() {
    setMapOnAll(null);
  }


function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -34.397, lng: 150.644 },
        zoom: 8,
        disableDefaultUI: true
    });

    var geocoder = new google.maps.Geocoder();
    var reverse = new google.maps.Geocoder();
    var infowindow = new google.maps.InfoWindow;
    marker = new google.maps.Marker(
    {
        position: { lat: -34.397, lng: 150.644 }
    });
    


    //lấy tọa độ khi click chuột
    google.maps.event.addListener(map, 'click', function(event) {
        reverseLocation(event.latLng, reverse, infowindow);
    });
}

function reverseLocation(location, geocoder, infowindow) {
    geocoder.geocode({'location': location }, function(results, status) {
        if (status === 'OK') {
            if (results[0]) {
            //   map.setZoom(8);
                marker.setPosition(location);
                marker.setMap(map);
                infowindow.setContent(results[0].formatted_address);
                infowindow.open(map, marker);
            } else {
                window.alert('không tìm thấy');
            }
        } else {
            window.alert('Geocoder failed due to: ' + status);
        }
    });
}

function geocodeAddress(geocoder, resultsMap, infowindow, address) {

    //marker.setMap(map);
    geocoder.geocode({ 'address': address }, function(results, status) {
        if (status === 'OK') {
            resultsMap.setCenter(results[0].geometry.location);
            
            marker.setPosition(results[0].geometry.location);
            marker.setMap(map);
            console.log(results[0]);
            infowindow.setContent(results[0].formatted_address);
            infowindow.open(resultsMap, pin);
        } else {
            alert('không tìm thấy:  ' + status);
        }
    });
}
	
</script>

</body>
</html>